<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rechercher des membres - Ã‰glise de Dieu</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- BibliothÃ¨ques jsPDF pour export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <nav class="navbar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
        <div style="display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; width: 100%;">
            <!-- Logo et titre Ã  gauche -->
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="font-size: 32px;">â›ª</div>
                <div>
                    <div style="font-size: 28px; font-weight: bold; color: white; letter-spacing: 0.5px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">
                        Ã‰glise de Dieu - Maison de LumiÃ¨re
                    </div>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.9); margin-top: 2px;">
                        SystÃ¨me de Gestion des Membres
                    </div>
                </div>
            </div>
            
            <!-- Boutons utilisateur Ã  droite -->
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="background: rgba(255,255,255,0.15); padding: 8px 16px; border-radius: 20px; color: white; font-size: 14px; font-weight: 500;">
                    ğŸ‘¤ <span id="user-role">Administrateur</span>
                </div>
                <button onclick="window.location.href='dashboard.html'" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    â† Retour
                </button>
                <button onclick="deconnexion()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px; box-shadow: 0 2px 8px rgba(245,87,108,0.3); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(245,87,108,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(245,87,108,0.3)'">
                    ğŸšª DÃ©connexion
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1 style="font-size: 36px; font-weight: bold; color: #1e293b; margin-bottom: 30px; text-align: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">
            ğŸ” Rechercher des membres
        </h1>

        <div class="search-container" style="margin-bottom: 30px;">
            <input 
                type="text" 
                id="recherche" 
                placeholder="Rechercher par nom, prÃ©nom, email ou tÃ©lÃ©phone..."
                onkeyup="rechercherMembres()"
                style="flex: 1; padding: 14px 20px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;"
            >
            <button onclick="rechercherMembres()" class="btn-primary" style="padding: 14px 28px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 16px; box-shadow: 0 4px 12px rgba(102,126,234,0.4); transition: all 0.3s;">
                ğŸ” Rechercher
            </button>
            <button onclick="voirTous()" class="btn-secondary" style="padding: 14px 28px; background: linear-gradient(135deg, #48c6ef 0%, #6f86d6 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 16px; box-shadow: 0 4px 12px rgba(72,198,239,0.4); transition: all 0.3s;">
                ğŸ‘¥ Voir tous
            </button>
        </div>

        <!-- Boutons d'export -->
        <div style="display: flex; gap: 12px; margin: 25px 0; justify-content: flex-end; flex-wrap: wrap;">
            <button onclick="exporterExcel()" style="display: flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px; box-shadow: 0 4px 12px rgba(17,153,142,0.4); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(17,153,142,0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(17,153,142,0.4)'">
                <span style="font-size: 20px;">ğŸ“Š</span>
                Exporter en Excel
            </button>
            <button onclick="exporterPDF()" style="display: flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px; box-shadow: 0 4px 12px rgba(238,9,121,0.4); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(238,9,121,0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(238,9,121,0.4)'">
                <span style="font-size: 20px;">ğŸ“„</span>
                Exporter en PDF
            </button>
        </div>

        <div id="compteur-membres" style="text-align: right; color: #64748b; margin-bottom: 10px;">
            <span id="nombre-membres">0</span> membre(s)
        </div>

        <div id="resultats-recherche" class="membres-grid"></div>
    </div>

    <script>
        const API_URL = 'https://eglise-maison-lumiere.onrender.com';
        let tousMembres = [];

        // Fonction de dÃ©connexion
        function deconnexion() {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }

        // VÃ©rifier l'authentification
        function verifierAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Fonction pour rechercher les membres - AVEC FALLBACK INTELLIGENT
        async function rechercherMembres() {
            if (!verifierAuth()) return;

            const champRecherche = document.getElementById('recherche');
            if (!champRecherche) {
                console.error('âŒ Champ de recherche introuvable');
                return;
            }

            const recherche = champRecherche.value.trim();
            const token = localStorage.getItem('token');

            console.log('ğŸ” === DÃ‰BUT RECHERCHE ===');
            console.log('ğŸ“ Terme:', recherche);
            console.log('ğŸ”‘ Token:', token ? 'âœ… PrÃ©sent' : 'âŒ Absent');

            try {
                let url = `${API_URL}/api/membres`;
                
                if (recherche) {
                    url = `${API_URL}/api/membres/rechercher?q=${encodeURIComponent(recherche)}`;
                }

                console.log('ğŸŒ URL appelÃ©e:', url);

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('ğŸ“¡ Status HTTP:', response.status, response.statusText);

                // Session expirÃ©e
                if (response.status === 401) {
                    console.error('ğŸ”’ Session expirÃ©e (401)');
                    alert('â±ï¸ Session expirÃ©e. Veuillez vous reconnecter.');
                    localStorage.removeItem('token');
                    window.location.href = 'login.html';
                    return;
                }

                // Endpoint non trouvÃ© OU erreur - ACTIVER LE FALLBACK
                if (response.status === 404 || !response.ok) {
                    console.warn('âš ï¸ Erreur ' + response.status + ' - Activation du FALLBACK');
                    
                    // FALLBACK : RÃ©cupÃ©rer TOUS les membres et filtrer localement
                    const fallbackResponse = await fetch(`${API_URL}/api/membres`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    console.log('ğŸ”„ Fallback Status:', fallbackResponse.status);

                    if (fallbackResponse.ok) {
                        const allMembers = await fallbackResponse.json();
                        console.log('âœ… Fallback rÃ©ussi - Total membres:', allMembers.length);
                        
                        // Si recherche, filtrer localement
                        if (recherche) {
                            const searchLower = recherche.toLowerCase();
                            const filtered = allMembers.filter(m => {
                                return (
                                    (m.nom && m.nom.toLowerCase().includes(searchLower)) ||
                                    (m.prenom && m.prenom.toLowerCase().includes(searchLower)) ||
                                    (m.email && m.email.toLowerCase().includes(searchLower)) ||
                                    (m.phone && m.phone.toLowerCase().includes(searchLower))
                                );
                            });
                            console.log('ğŸ¯ Membres filtrÃ©s localement:', filtered.length);
                            tousMembres = filtered;
                            afficherResultats(filtered);
                        } else {
                            tousMembres = allMembers;
                            afficherResultats(allMembers);
                        }
                        return;
                    } else {
                        throw new Error(`Fallback Ã©chouÃ©: ${fallbackResponse.status}`);
                    }
                }

                // SuccÃ¨s normal
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('âŒ RÃ©ponse non-JSON:', text.substring(0, 200));
                    throw new Error('RÃ©ponse serveur invalide (non-JSON)');
                }

                const membres = await response.json();
                console.log('âœ… Membres trouvÃ©s:', membres.length);

                tousMembres = membres;
                afficherResultats(membres);

            } catch (error) {
                console.error('ğŸ’¥ ERREUR CRITIQUE:', error.name, error.message);
                console.error('Stack:', error.stack);
                
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    alert('âŒ Impossible de se connecter au serveur.\n\nğŸ“¡ VÃ©rifiez votre connexion internet.');
                } else if (error.message.includes('timeout')) {
                    alert('â±ï¸ Le serveur met trop de temps Ã  rÃ©pondre.\n\nğŸ”„ RÃ©essayez dans quelques instants.');
                } else {
                    alert('âŒ Erreur lors de la recherche.\n\nğŸ’» Consultez la console (F12) pour plus d\'informations.');
                }
            }
        }

        // Fonction pour afficher les rÃ©sultats
        function afficherResultats(membres) {
            console.log('ğŸ“Š === AFFICHAGE RÃ‰SULTATS ===');
            console.log('ğŸ“‹ Nombre de membres:', membres.length);
            
            const resultatsDiv = document.getElementById('resultats-recherche');
            const compteur = document.getElementById('nombre-membres');
            
            if (!resultatsDiv) {
                console.error('âŒ Element "resultats-recherche" introuvable');
                return;
            }
            
            resultatsDiv.innerHTML = '';
            
            if (compteur) {
                compteur.textContent = membres.length;
            }

            // Si aucun rÃ©sultat
            if (membres.length === 0) {
                resultatsDiv.innerHTML = `
                    <div style="text-align: center; padding: 80px 20px; color: #64748b;">
                        <div style="font-size: 80px; margin-bottom: 24px; opacity: 0.5;">ğŸ”</div>
                        <h3 style="font-size: 28px; font-weight: bold; color: #1e293b; margin-bottom: 16px;">
                            Aucun membre trouvÃ©
                        </h3>
                        <p style="font-size: 18px; margin-bottom: 32px; color: #64748b;">
                            Aucun rÃ©sultat ne correspond Ã  votre recherche
                        </p>
                        <button onclick="voirTous()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 16px 40px; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer; box-shadow: 0 8px 20px rgba(102,126,234,0.4); transition: all 0.3s; display: inline-flex; align-items: center; gap: 10px;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 12px 28px rgba(102,126,234,0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 20px rgba(102,126,234,0.4)'">
                            <span style="font-size: 24px;">ğŸ‘¥</span>
                            Voir tous les membres
                        </button>
                    </div>
                `;
                console.log('ğŸ“­ Message "Aucun rÃ©sultat" affichÃ©');
                return;
            }

            // Afficher les membres
            membres.forEach((membre, index) => {
                const card = document.createElement('div');
                card.className = 'membre-card';
                
                card.innerHTML = `
                    <div class="membre-info">
                        <div class="membre-nom">${membre.nom || ''} ${membre.prenom || ''}</div>
                        <div class="membre-details">
                            <span><strong>ğŸ“ TÃ©lÃ©phone:</strong> ${membre.phone || 'N/A'}</span>
                            <span><strong>ğŸ“§ Email:</strong> ${membre.email || 'N/A'}</span>
                            <span><strong>ğŸ“ Adresse:</strong> ${membre.adresse || 'N/A'}</span>
                            ${membre.statut_matrimonial ? `<span><strong>ğŸ‘¥ Statut:</strong> ${membre.statut_matrimonial}</span>` : ''}
                            ${membre.nombre_enfants !== null && membre.nombre_enfants !== undefined ? `<span><strong>ğŸ‘¶ Enfants:</strong> ${membre.nombre_enfants}</span>` : ''}
                            ${membre.nationalite ? `<span><strong>ğŸŒ NationalitÃ©:</strong> ${membre.nationalite}</span>` : ''}
                            ${membre.langue_parlee ? `<span><strong>ğŸ—£ï¸ Langue:</strong> ${membre.langue_parlee}</span>` : ''}
                            ${membre.niveau_etude ? `<span><strong>ğŸ“ Niveau:</strong> ${membre.niveau_etude}</span>` : ''}
                        </div>
                    </div>
                    <div class="membre-actions">
                        <button onclick="modifierMembre('${membre.id}')" class="btn-modifier" style="display: inline-flex; align-items: center; gap: 6px;">
                            <span>âœï¸</span> Modifier
                        </button>
                        <button onclick="supprimerMembre('${membre.id}')" class="btn-supprimer" style="display: inline-flex; align-items: center; gap: 6px;">
                            <span>ğŸ—‘ï¸</span> Supprimer
                        </button>
                    </div>
                `;
                
                resultatsDiv.appendChild(card);
            });
            
            console.log('âœ… Affichage de', membres.length, 'membre(s) terminÃ©');
        }

        // Fonction pour voir tous les membres
        function voirTous() {
            console.log('ğŸ‘¥ === VOIR TOUS LES MEMBRES ===');
            const champRecherche = document.getElementById('recherche');
            if (champRecherche) {
                champRecherche.value = '';
                console.log('ğŸ—‘ï¸ Champ de recherche vidÃ©');
            }
            rechercherMembres();
        }

        // Fonction pour modifier un membre
        function modifierMembre(id) {
            window.location.href = `modifier.html?id=${id}`;
        }

        // Fonction pour supprimer un membre
        async function supprimerMembre(id) {
            if (!confirm('ÃŠtes-vous sÃ»r de vouloir supprimer ce membre ?')) {
                return;
            }

            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`${API_URL}/api/membres/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    alert('âœ… Membre supprimÃ© avec succÃ¨s');
                    rechercherMembres();
                } else {
                    const error = await response.json();
                    alert(`âŒ Erreur: ${error.message || 'Impossible de supprimer le membre'}`);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('âŒ Erreur lors de la suppression du membre');
            }
        }

        // Fonction pour exporter en Excel (CSV)
        function exporterExcel() {
            if (tousMembres.length === 0) {
                alert('Aucun membre Ã  exporter');
                return;
            }

            const headers = ['Nom', 'PrÃ©nom', 'TÃ©lÃ©phone', 'Email', 'Adresse', 'Statut', 'Enfants', 'NationalitÃ©', 'Langue', 'Niveau'];
            
            const rows = tousMembres.map(m => [
                m.nom || '',
                m.prenom || '',
                m.phone || '',
                m.email || '',
                m.adresse || '',
                m.statut_matrimonial || '',
                m.nombre_enfants || '',
                m.nationalite || '',
                m.langue_parlee || '',
                m.niveau_etude || ''
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const date = new Date().toISOString().split('T')[0];
            
            link.href = url;
            link.download = `membres-eglise-${date}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert(`âœ… ${tousMembres.length} membre(s) exportÃ©(s) en Excel`);
        }

        // Fonction pour exporter en PDF
        function exporterPDF() {
            if (tousMembres.length === 0) {
                alert('Aucun membre Ã  exporter');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');

            // En-tÃªte
            doc.setFillColor(99, 102, 241);
            doc.rect(0, 0, 297, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.text('Ã‰glise de Dieu - Maison de LumiÃ¨re', 148.5, 15, { align: 'center' });
            doc.setFontSize(14);
            doc.text('Liste des Membres', 148.5, 25, { align: 'center' });
            doc.setFontSize(10);
            const dateStr = new Date().toLocaleDateString('fr-FR');
            doc.text(`Date: ${dateStr}`, 148.5, 33, { align: 'center' });

            // Tableau
            const tableData = tousMembres.map(m => [
                m.nom || '',
                m.prenom || '',
                m.phone || '',
                m.email || '',
                m.statut_matrimonial || '',
                m.nationalite || ''
            ]);

            doc.autoTable({
                startY: 45,
                head: [['Nom', 'PrÃ©nom', 'TÃ©lÃ©phone', 'Email', 'Statut', 'NationalitÃ©']],
                body: tableData,
                theme: 'striped',
                headStyles: {
                    fillColor: [99, 102, 241],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                styles: {
                    fontSize: 9,
                    cellPadding: 3
                },
                didDrawPage: function(data) {
                    doc.setFontSize(8);
                    doc.setTextColor(128);
                    doc.text(
                        `Page ${data.pageNumber} | Total: ${tousMembres.length} membre(s)`,
                        148.5,
                        doc.internal.pageSize.height - 10,
                        { align: 'center' }
                    );
                }
            });

            const date = new Date().toISOString().split('T')[0];
            doc.save(`membres-eglise-${date}.pdf`);

            alert(`âœ… ${tousMembres.length} membre(s) exportÃ©(s) en PDF`);
        }

        // Charger tous les membres au dÃ©marrage
        window.addEventListener('DOMContentLoaded', function() {
            if (verifierAuth()) {
                rechercherMembres();
            }
        });
    </script>
</body>
</html>
