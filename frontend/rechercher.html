<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rechercher des membres - √âglise de Dieu</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Biblioth√®ques jsPDF pour export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <nav class="navbar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
        <div style="display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; width: 100%;">
            <!-- Logo et titre √† gauche -->
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="font-size: 32px;">‚õ™</div>
                <div>
                    <div style="font-size: 28px; font-weight: bold; color: white; letter-spacing: 0.5px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">
                        √âglise de Dieu - Maison de Lumi√®re
                    </div>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.9); margin-top: 2px;">
                        Syst√®me de Gestion des Membres
                    </div>
                </div>
            </div>
            
            <!-- Boutons utilisateur √† droite -->
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="background: rgba(255,255,255,0.15); padding: 8px 16px; border-radius: 20px; color: white; font-size: 14px; font-weight: 500;">
                    üë§ <span id="user-role">Administrateur</span>
                </div>
                <button onclick="window.location.href='dashboard.html'" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    ‚Üê Retour
                </button>
                <button onclick="deconnexion()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px; box-shadow: 0 2px 8px rgba(245,87,108,0.3); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(245,87,108,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(245,87,108,0.3)'">
                    üö™ D√©connexion
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1 style="font-size: 36px; font-weight: bold; color: #1e293b; margin-bottom: 30px; text-align: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">
            üîç Rechercher des membres
        </h1>

        <div class="search-container" style="margin-bottom: 30px;">
            <input 
                type="text" 
                id="recherche" 
                placeholder="Rechercher par nom, pr√©nom, email ou t√©l√©phone..."
                onkeyup="rechercherMembres()"
                style="flex: 1; padding: 14px 20px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;"
            >
            <button onclick="rechercherMembres()" class="btn-primary" style="padding: 14px 28px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 16px; box-shadow: 0 4px 12px rgba(102,126,234,0.4); transition: all 0.3s;">
                üîç Rechercher
            </button>
            <button onclick="voirTous()" class="btn-secondary" style="padding: 14px 28px; background: linear-gradient(135deg, #48c6ef 0%, #6f86d6 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 16px; box-shadow: 0 4px 12px rgba(72,198,239,0.4); transition: all 0.3s;">
                üë• Voir tous
            </button>
        </div>

        <!-- Boutons d'export -->
        <div style="display: flex; gap: 12px; margin: 25px 0; justify-content: flex-end; flex-wrap: wrap;">
            <button onclick="exporterExcel()" style="display: flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px; box-shadow: 0 4px 12px rgba(17,153,142,0.4); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(17,153,142,0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(17,153,142,0.4)'">
                <span style="font-size: 20px;">üìä</span>
                Exporter en Excel
            </button>
            <button onclick="exporterPDF()" style="display: flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px; box-shadow: 0 4px 12px rgba(238,9,121,0.4); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(238,9,121,0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(238,9,121,0.4)'">
                <span style="font-size: 20px;">üìÑ</span>
                Exporter en PDF
            </button>
        </div>

        <div id="compteur-membres" style="text-align: right; color: #64748b; margin-bottom: 10px;">
            <span id="nombre-membres">0</span> membre(s)
        </div>

        <div id="resultats-recherche" class="membres-grid"></div>
    </div>

    <script>
        const API_URL = 'https://eglise-maison-lumiere.onrender.com';
        let tousMembres = [];

        // Fonction de d√©connexion
        function deconnexion() {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }

        // V√©rifier l'authentification
        function verifierAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Fonction pour rechercher les membres - VERSION AM√âLIOR√âE
        async function rechercherMembres() {
            if (!verifierAuth()) return;

            const champRecherche = document.getElementById('recherche');
            if (!champRecherche) {
                console.error('Champ de recherche introuvable');
                return;
            }

            const recherche = champRecherche.value.trim();
            const token = localStorage.getItem('token');

            console.log('=== D√âBUT RECHERCHE ===');
            console.log('Terme de recherche:', recherche);
            console.log('Token pr√©sent:', !!token);

            try {
                let url = `${API_URL}/api/membres`;
                
                // Si recherche non vide, utiliser l'endpoint de recherche
                if (recherche) {
                    url = `${API_URL}/api/membres/rechercher?q=${encodeURIComponent(recherche)}`;
                }

                console.log('URL de la requ√™te:', url);

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Status HTTP:', response.status);
                console.log('Status Text:', response.statusText);

                // Gestion des diff√©rents codes d'erreur
                if (response.status === 401) {
                    console.error('Session expir√©e (401)');
                    alert('‚è±Ô∏è Session expir√©e. Veuillez vous reconnecter.');
                    localStorage.removeItem('token');
                    window.location.href = 'login.html';
                    return;
                }

                if (response.status === 404) {
                    console.warn('Endpoint non trouv√© (404) - Tentative avec /api/membres');
                    // Si l'endpoint de recherche n'existe pas, r√©cup√©rer tous les membres
                    const fallbackResponse = await fetch(`${API_URL}/api/membres`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (fallbackResponse.ok) {
                        const tousMembresData = await fallbackResponse.json();
                        console.log('Fallback r√©ussi - Membres r√©cup√©r√©s:', tousMembresData.length);
                        
                        // Filtrer localement si n√©cessaire
                        let membresAfficher = tousMembresData;
                        if (recherche) {
                            membresAfficher = tousMembresData.filter(m => {
                                const searchLower = recherche.toLowerCase();
                                return (
                                    (m.nom && m.nom.toLowerCase().includes(searchLower)) ||
                                    (m.prenom && m.prenom.toLowerCase().includes(searchLower)) ||
                                    (m.email && m.email.toLowerCase().includes(searchLower)) ||
                                    (m.phone && m.phone.toLowerCase().includes(searchLower))
                                );
                            });
                            console.log('Membres filtr√©s localement:', membresAfficher.length);
                        }
                        
                        tousMembres = membresAfficher;
                        afficherResultats(membresAfficher);
                        return;
                    } else {
                        throw new Error(`Erreur fallback: ${fallbackResponse.status}`);
                    }
                }

                if (response.status === 500) {
                    console.error('Erreur serveur (500)');
                    alert('‚ùå Erreur serveur. Veuillez r√©essayer dans quelques instants.');
                    return;
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Erreur r√©ponse:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                // Succ√®s - Parser la r√©ponse
                const contentType = response.headers.get('content-type');
                console.log('Content-Type:', contentType);

                let membres;
                if (contentType && contentType.includes('application/json')) {
                    membres = await response.json();
                } else {
                    const text = await response.text();
                    console.error('R√©ponse non-JSON:', text);
                    throw new Error('R√©ponse serveur invalide (non-JSON)');
                }

                console.log('‚úÖ Membres trouv√©s:', membres.length);
                console.log('Membres:', membres);

                tousMembres = membres;
                afficherResultats(membres);

            } catch (error) {
                console.error('=== ERREUR RECHERCHE ===');
                console.error('Type:', error.name);
                console.error('Message:', error.message);
                console.error('Stack:', error.stack);

                // Message d'erreur plus informatif
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    alert('‚ùå Impossible de se connecter au serveur.\n\nV√©rifiez votre connexion internet ou r√©essayez plus tard.');
                } else if (error.message.includes('timeout')) {
                    alert('‚è±Ô∏è Le serveur met trop de temps √† r√©pondre.\n\nR√©essayez dans quelques instants.');
                } else {
                    alert('‚ùå Erreur lors de la recherche.\n\nVeuillez r√©essayer ou contacter l\'administrateur si le probl√®me persiste.');
                }
            }
        }

        // Fonction pour afficher les r√©sultats - AM√âLIOR√âE
        function afficherResultats(membres) {
            console.log('=== AFFICHAGE R√âSULTATS ===');
            console.log('Nombre de membres √† afficher:', membres.length);
            
            const resultatsDiv = document.getElementById('resultats-recherche');
            const compteur = document.getElementById('nombre-membres');
            
            if (!resultatsDiv) {
                console.error('Element "resultats-recherche" introuvable');
                return;
            }
            
            resultatsDiv.innerHTML = '';
            
            if (compteur) {
                compteur.textContent = membres.length;
            }

            if (membres.length === 0) {
                resultatsDiv.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #64748b;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üîç</div>
                        <h3 style="font-size: 20px; margin-bottom: 10px; color: #475569;">Aucun membre trouv√©</h3>
                        <p style="font-size: 16px;">Essayez une autre recherche ou cliquez sur "Voir tous"</p>
                    </div>
                `;
                return;
            }

            membres.forEach(membre => {
                const card = document.createElement('div');
                card.className = 'membre-card';
                
                card.innerHTML = `
                    <div class="membre-info">
                        <div class="membre-nom">${membre.nom || ''} ${membre.prenom || ''}</div>
                        <div class="membre-details">
                            <span><strong>üìû T√©l√©phone:</strong> ${membre.phone || 'N/A'}</span>
                            <span><strong>üìß Email:</strong> ${membre.email || 'N/A'}</span>
                            <span><strong>üìç Adresse:</strong> ${membre.adresse || 'N/A'}</span>
                            ${membre.statut_matrimonial ? `<span><strong>üë• Statut:</strong> ${membre.statut_matrimonial}</span>` : ''}
                            ${membre.nombre_enfants !== null && membre.nombre_enfants !== undefined ? `<span><strong>üë∂ Enfants:</strong> ${membre.nombre_enfants}</span>` : ''}
                            ${membre.nationalite ? `<span><strong>üåç Nationalit√©:</strong> ${membre.nationalite}</span>` : ''}
                            ${membre.langue_parlee ? `<span><strong>üó£Ô∏è Langue:</strong> ${membre.langue_parlee}</span>` : ''}
                            ${membre.niveau_etude ? `<span><strong>üéì Niveau d'√©tude:</strong> ${membre.niveau_etude}</span>` : ''}
                        </div>
                    </div>
                    <div class="membre-actions">
                        <button onclick="modifierMembre('${membre.id}')" class="btn-modifier">
                            Modifier
                        </button>
                        <button onclick="supprimerMembre('${membre.id}')" class="btn-supprimer">
                            Supprimer
                        </button>
                    </div>
                `;
                
                resultatsDiv.appendChild(card);
            });
            
            console.log('‚úÖ Affichage termin√©');
        }

        // Fonction pour voir tous les membres
        function voirTous() {
            console.log('=== VOIR TOUS ===');
            const champRecherche = document.getElementById('recherche');
            if (champRecherche) {
                champRecherche.value = '';
            }
            rechercherMembres();
        }

        // Fonction pour modifier un membre
        function modifierMembre(id) {
            window.location.href = `modifier.html?id=${id}`;
        }

        // Fonction pour supprimer un membre
        async function supprimerMembre(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce membre ?')) {
                return;
            }

            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`${API_URL}/api/membres/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    alert('‚úÖ Membre supprim√© avec succ√®s');
                    rechercherMembres();
                } else {
                    const error = await response.json();
                    alert(`‚ùå Erreur: ${error.message || 'Impossible de supprimer le membre'}`);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de la suppression du membre');
            }
        }

        // Fonction pour exporter en Excel (CSV)
        function exporterExcel() {
            if (tousMembres.length === 0) {
                alert('Aucun membre √† exporter');
                return;
            }

            const headers = ['Nom', 'Pr√©nom', 'T√©l√©phone', 'Email', 'Adresse', 'Statut', 'Enfants', 'Nationalit√©', 'Langue', 'Niveau'];
            
            const rows = tousMembres.map(m => [
                m.nom || '',
                m.prenom || '',
                m.phone || '',
                m.email || '',
                m.adresse || '',
                m.statut_matrimonial || '',
                m.nombre_enfants || '',
                m.nationalite || '',
                m.langue_parlee || '',
                m.niveau_etude || ''
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const date = new Date().toISOString().split('T')[0];
            
            link.href = url;
            link.download = `membres-eglise-${date}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert(`‚úÖ ${tousMembres.length} membre(s) export√©(s) en Excel`);
        }

        // Fonction pour exporter en PDF
        function exporterPDF() {
            if (tousMembres.length === 0) {
                alert('Aucun membre √† exporter');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');

            // En-t√™te
            doc.setFillColor(99, 102, 241);
            doc.rect(0, 0, 297, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.text('√âglise de Dieu - Maison de Lumi√®re', 148.5, 15, { align: 'center' });
            doc.setFontSize(14);
            doc.text('Liste des Membres', 148.5, 25, { align: 'center' });
            doc.setFontSize(10);
            const dateStr = new Date().toLocaleDateString('fr-FR');
            doc.text(`Date: ${dateStr}`, 148.5, 33, { align: 'center' });

            // Tableau
            const tableData = tousMembres.map(m => [
                m.nom || '',
                m.prenom || '',
                m.phone || '',
                m.email || '',
                m.statut_matrimonial || '',
                m.nationalite || ''
            ]);

            doc.autoTable({
                startY: 45,
                head: [['Nom', 'Pr√©nom', 'T√©l√©phone', 'Email', 'Statut', 'Nationalit√©']],
                body: tableData,
                theme: 'striped',
                headStyles: {
                    fillColor: [99, 102, 241],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                styles: {
                    fontSize: 9,
                    cellPadding: 3
                },
                didDrawPage: function(data) {
                    doc.setFontSize(8);
                    doc.setTextColor(128);
                    doc.text(
                        `Page ${data.pageNumber} | Total: ${tousMembres.length} membre(s)`,
                        148.5,
                        doc.internal.pageSize.height - 10,
                        { align: 'center' }
                    );
                }
            });

            const date = new Date().toISOString().split('T')[0];
            doc.save(`membres-eglise-${date}.pdf`);

            alert(`‚úÖ ${tousMembres.length} membre(s) export√©(s) en PDF`);
        }

        // Charger tous les membres au d√©marrage
        window.addEventListener('DOMContentLoaded', function() {
            if (verifierAuth()) {
                rechercherMembres();
            }
        });
    </script>
</body>
</html>
