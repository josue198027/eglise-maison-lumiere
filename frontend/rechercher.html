<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rechercher des membres - √âglise de Dieu Maison de Lumi√®re</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-left">
        <img src="images/logo.png" alt="Logo" class="nav-logo" onerror="this.style.display='none'">
        <span class="nav-title">√âglise de Dieu - Maison de Lumi√®re</span>
      </div>
      <div class="nav-right">
        <span class="user-name" id="userName"></span>
        <button onclick="window.location.href='/dashboard.html'" class="btn btn-secondary">Retour</button>
        <button onclick="deconnexion()" class="btn btn-secondary">D√©connexion</button>
      </div>
    </div>
  </nav>

  <!-- Contenu principal -->
  <div class="container">
    <h1 class="page-title">Rechercher et consulter les membres</h1>

    <!-- Barre de recherche -->
    <div class="search-container">
      <input type="text" id="recherche" placeholder="Rechercher par nom, pr√©nom, email ou t√©l√©phone..." class="search-input">
      <button onclick="rechercherMembres()" class="btn btn-primary">Rechercher</button>
      <button onclick="voirTous()" class="btn btn-secondary">Voir tous</button>
      <button onclick="exporterCSV()" class="btn btn-success">üìä Exporter en Excel</button>
      <button onclick="exporterPDF()" class="btn btn-info">üìÑ Exporter en PDF</button>
    </div>

    <!-- Compteur de membres -->
    <div style="text-align: center; margin: 20px 0; font-size: 18px; font-weight: 600; color: #6366f1;">
      <span id="nombre-membres">0</span> membre(s) trouv√©(s)
    </div>

    <!-- Message -->
    <div id="message" class="message" style="display: none;"></div>

    <!-- R√©sultats -->
    <div id="resultats-recherche" class="membres-grid"></div>
  </div>

  <script src="js/app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // 1. Constantes et variables globales
    const API_URL = 'https://eglise-maison-lumiere.onrender.com';
    let tousMembres = [];

    // V√©rifier l'authentification
    verifierAuth();
    afficherNomUtilisateur();

    // 2. Fonctions principales
    async function rechercherMembres() {
      const recherche = document.getElementById('recherche').value.trim();
      
      try {
        const token = localStorage.getItem('token');
        let url = `${API_URL}/api/membres`;
        
        if (recherche) {
          url = `${API_URL}/api/membres/rechercher?q=${encodeURIComponent(recherche)}`;
        }
        
        const response = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const membres = await response.json();
          afficherResultats(membres);
        } else if (response.status === 401) {
          alert('Session expir√©e. Veuillez vous reconnecter.');
          window.location.href = '/login.html';
        } else {
          alert('Erreur lors de la recherche');
        }
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la recherche');
      }
    }

    function afficherResultats(membres) {
      // Stocker pour l'export
      tousMembres = membres;
      
      const resultatsDiv = document.getElementById('resultats-recherche');
      resultatsDiv.innerHTML = '';

      if (membres.length === 0) {
        resultatsDiv.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">Aucun membre trouv√©</p>';
        // Mettre √† jour le compteur
        const compteurElement = document.getElementById('nombre-membres');
        if (compteurElement) {
          compteurElement.textContent = 0;
        }
        return;
      }

      membres.forEach(membre => {
        const membreCard = document.createElement('div');
        membreCard.className = 'membre-card';
        
        // Construire les d√©tails
        let detailsHTML = `
          <div class="membre-info">
            <div class="membre-nom">${membre.nom || ''} ${membre.prenom || ''}</div>
            <div class="membre-details">
              <span><strong>üìû T√©l√©phone:</strong> ${membre.phone || 'N/A'}</span>
              <span><strong>üìç Adresse:</strong> ${membre.adresse || 'N/A'}</span>
        `;
        
        // Ajouter les d√©tails suppl√©mentaires s'ils existent
        if (membre.statut_matrimonial) {
          detailsHTML += `<span><strong>üë• Statut:</strong> ${membre.statut_matrimonial}</span>`;
        }
        if (membre.nombre_enfants !== null && membre.nombre_enfants !== undefined) {
          detailsHTML += `<span><strong>üë∂ Enfants:</strong> ${membre.nombre_enfants}</span>`;
        }
        if (membre.nationalite) {
          detailsHTML += `<span><strong>üåç Nationalit√©:</strong> ${membre.nationalite}</span>`;
        }
        if (membre.langue_parlee) {
          detailsHTML += `<span><strong>üó£Ô∏è Langue:</strong> ${membre.langue_parlee}</span>`;
        }
        if (membre.niveau_etude) {
          detailsHTML += `<span><strong>üéì Niveau d'√©tude:</strong> ${membre.niveau_etude}</span>`;
        }
        
        detailsHTML += `
            </div>
          </div>
          <div class="membre-actions">
            <button onclick="window.location.href='/modifier.html?id=${membre.id}'" class="btn-modifier">
              Modifier
            </button>
            <button onclick="supprimerMembre('${membre.id}')" class="btn-supprimer">
              Supprimer
            </button>
          </div>
        `;
        
        membreCard.innerHTML = detailsHTML;
        resultatsDiv.appendChild(membreCard);
      });
      
      // Mettre √† jour le compteur
      const compteurElement = document.getElementById('nombre-membres');
      if (compteurElement) {
        compteurElement.textContent = membres.length;
      }
    }

    async function supprimerMembre(id) {
      if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce membre ?')) {
        return;
      }

      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_URL}/api/membres/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          alert('‚úÖ Membre supprim√© avec succ√®s');
          // Recharger les r√©sultats
          rechercherMembres();
        } else {
          const error = await response.json();
          alert(`‚ùå Erreur: ${error.message || 'Impossible de supprimer le membre'}`);
        }
      } catch (error) {
        console.error('Erreur lors de la suppression:', error);
        alert('‚ùå Erreur lors de la suppression du membre');
      }
    }

    function voirTous() {
      document.getElementById('recherche').value = '';
      rechercherMembres();
    }

    // 3. Fonctions d'export
    function exporterCSV() {
      if (tousMembres.length === 0) {
        alert('Aucun membre √† exporter');
        return;
      }

      // Cr√©er l'en-t√™te CSV
      const headers = ['Nom', 'Pr√©nom', 'T√©l√©phone', 'Email', 'Adresse', 'Statut matrimonial', 'Nombre d\'enfants', 'Nationalit√©', 'Langue parl√©e', 'Niveau d\'√©tude'];
      
      // Cr√©er les lignes CSV
      const rows = tousMembres.map(membre => [
        membre.nom || '',
        membre.prenom || '',
        membre.phone || '',
        membre.email || '',
        membre.adresse || '',
        membre.statut_matrimonial || '',
        membre.nombre_enfants !== null ? membre.nombre_enfants : '',
        membre.nationalite || '',
        membre.langue_parlee || '',
        membre.niveau_etude || ''
      ]);

      // Combiner en-t√™te et lignes
      const csvContent = [headers, ...rows]
        .map(row => row.map(cell => `"${cell}"`).join(','))
        .join('\n');

      // Cr√©er et t√©l√©charger le fichier
      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `membres_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function exporterPDF() {
      if (tousMembres.length === 0) {
        alert('Aucun membre √† exporter');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Titre
      doc.setFontSize(18);
      doc.text('Liste des membres', 105, 15, { align: 'center' });
      doc.setFontSize(10);
      doc.text(`Date: ${new Date().toLocaleDateString()}`, 105, 22, { align: 'center' });

      let yPosition = 35;
      const lineHeight = 7;
      const pageHeight = doc.internal.pageSize.height;

      tousMembres.forEach((membre, index) => {
        // V√©rifier si on doit ajouter une nouvelle page
        if (yPosition > pageHeight - 30) {
          doc.addPage();
          yPosition = 20;
        }

        // Afficher les informations du membre
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text(`${membre.nom || ''} ${membre.prenom || ''}`, 15, yPosition);
        
        yPosition += lineHeight;
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        
        if (membre.phone) {
          doc.text(`T√©l√©phone: ${membre.phone}`, 20, yPosition);
          yPosition += lineHeight;
        }
        if (membre.email) {
          doc.text(`Email: ${membre.email}`, 20, yPosition);
          yPosition += lineHeight;
        }
        if (membre.adresse) {
          doc.text(`Adresse: ${membre.adresse}`, 20, yPosition);
          yPosition += lineHeight;
        }

        // Ligne de s√©paration
        yPosition += 3;
        doc.setDrawColor(200, 200, 200);
        doc.line(15, yPosition, 195, yPosition);
        yPosition += 5;
      });

      // Sauvegarder le PDF
      doc.save(`membres_${new Date().toISOString().split('T')[0]}.pdf`);
    }

    // 4. Gestionnaires d'√©v√©nements
    window.addEventListener('DOMContentLoaded', async () => {
      // Charger tous les membres au d√©marrage
      await rechercherMembres();
    });

    // Recherche en temps r√©el
    document.getElementById('recherche').addEventListener('input', (e) => {
      const query = e.target.value.trim();
      if (query.length > 0) {
        rechercherMembres();
      } else {
        voirTous();
      }
    });

    // Rechercher avec la touche Entr√©e
    document.getElementById('recherche').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        rechercherMembres();
      }
    });
  </script>
</body>
</html>
