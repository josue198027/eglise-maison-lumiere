<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rechercher des membres - √âglise de Dieu</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Biblioth√®ques jsPDF pour export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">√âglise de Dieu - Maison de Lumi√®re</div>
        <div class="nav-user">
            <span id="user-role">Administrateur</span>
            <button onclick="window.location.href='index.html'" class="btn-retour">Retour</button>
            <button onclick="deconnexion()" class="btn-deconnexion">D√©connexion</button>
        </div>
    </nav>

    <div class="container">
        <h1>Rechercher des membres</h1>

        <div class="search-container">
            <input 
                type="text" 
                id="recherche" 
                placeholder="Rechercher par nom, pr√©nom, email ou t√©l√©phone..."
                onkeyup="rechercherMembres()"
            >
            <button onclick="rechercherMembres()" class="btn-primary">Rechercher</button>
            <button onclick="voirTous()" class="btn-secondary">Voir tous</button>
        </div>

        <!-- Boutons d'export -->
        <div style="display: flex; gap: 10px; margin: 20px 0; justify-content: flex-end;">
            <button onclick="exporterExcel()" class="btn-success">
                üì• Exporter en Excel
            </button>
            <button onclick="exporterPDF()" class="btn-danger">
                üìÑ Exporter en PDF
            </button>
        </div>

        <div id="compteur-membres" style="text-align: right; color: #64748b; margin-bottom: 10px;">
            <span id="nombre-membres">0</span> membre(s)
        </div>

        <div id="resultats-recherche" class="membres-grid"></div>
    </div>

    <script>
        const API_URL = 'https://eglise-maison-lumiere.onrender.com';
        let tousMembres = [];

        // Fonction de d√©connexion
        function deconnexion() {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }

        // V√©rifier l'authentification
        function verifierAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Fonction pour rechercher les membres
        async function rechercherMembres() {
            if (!verifierAuth()) return;

            const recherche = document.getElementById('recherche').value.trim();
            const token = localStorage.getItem('token');

            try {
                let url = `${API_URL}/api/membres`;
                
                if (recherche) {
                    url = `${API_URL}/api/membres/rechercher?q=${encodeURIComponent(recherche)}`;
                }

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    alert('Session expir√©e. Veuillez vous reconnecter.');
                    window.location.href = 'login.html';
                    return;
                }

                if (response.ok) {
                    const membres = await response.json();
                    tousMembres = membres;
                    afficherResultats(membres);
                } else {
                    console.error('Erreur:', response.status);
                    alert('Erreur lors de la recherche');
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur de connexion au serveur');
            }
        }

        // Fonction pour afficher les r√©sultats
        function afficherResultats(membres) {
            const resultatsDiv = document.getElementById('resultats-recherche');
            const compteur = document.getElementById('nombre-membres');
            
            resultatsDiv.innerHTML = '';
            compteur.textContent = membres.length;

            if (membres.length === 0) {
                resultatsDiv.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">Aucun membre trouv√©</p>';
                return;
            }

            membres.forEach(membre => {
                const card = document.createElement('div');
                card.className = 'membre-card';
                
                card.innerHTML = `
                    <div class="membre-info">
                        <div class="membre-nom">${membre.nom || ''} ${membre.prenom || ''}</div>
                        <div class="membre-details">
                            <span><strong>üìû T√©l√©phone:</strong> ${membre.phone || 'N/A'}</span>
                            <span><strong>üìß Email:</strong> ${membre.email || 'N/A'}</span>
                            <span><strong>üìç Adresse:</strong> ${membre.adresse || 'N/A'}</span>
                            ${membre.statut_matrimonial ? `<span><strong>üë• Statut:</strong> ${membre.statut_matrimonial}</span>` : ''}
                            ${membre.nombre_enfants !== null && membre.nombre_enfants !== undefined ? `<span><strong>üë∂ Enfants:</strong> ${membre.nombre_enfants}</span>` : ''}
                            ${membre.nationalite ? `<span><strong>üåç Nationalit√©:</strong> ${membre.nationalite}</span>` : ''}
                            ${membre.langue_parlee ? `<span><strong>üó£Ô∏è Langue:</strong> ${membre.langue_parlee}</span>` : ''}
                            ${membre.niveau_etude ? `<span><strong>üéì Niveau:</strong> ${membre.niveau_etude}</span>` : ''}
                        </div>
                    </div>
                    <div class="membre-actions">
                        <button onclick="modifierMembre('${membre.id}')" class="btn-modifier">
                            Modifier
                        </button>
                        <button onclick="supprimerMembre('${membre.id}')" class="btn-supprimer">
                            Supprimer
                        </button>
                    </div>
                `;
                
                resultatsDiv.appendChild(card);
            });
        }

        // Fonction pour voir tous les membres
        function voirTous() {
            document.getElementById('recherche').value = '';
            rechercherMembres();
        }

        // Fonction pour modifier un membre
        function modifierMembre(id) {
            window.location.href = `modifier.html?id=${id}`;
        }

        // Fonction pour supprimer un membre
        async function supprimerMembre(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce membre ?')) {
                return;
            }

            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`${API_URL}/api/membres/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    alert('‚úÖ Membre supprim√© avec succ√®s');
                    rechercherMembres();
                } else {
                    const error = await response.json();
                    alert(`‚ùå Erreur: ${error.message || 'Impossible de supprimer le membre'}`);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de la suppression du membre');
            }
        }

        // Fonction pour exporter en Excel (CSV)
        function exporterExcel() {
            if (tousMembres.length === 0) {
                alert('Aucun membre √† exporter');
                return;
            }

            const headers = ['Nom', 'Pr√©nom', 'T√©l√©phone', 'Email', 'Adresse', 'Statut', 'Enfants', 'Nationalit√©', 'Langue', 'Niveau'];
            
            const rows = tousMembres.map(m => [
                m.nom || '',
                m.prenom || '',
                m.phone || '',
                m.email || '',
                m.adresse || '',
                m.statut_matrimonial || '',
                m.nombre_enfants || '',
                m.nationalite || '',
                m.langue_parlee || '',
                m.niveau_etude || ''
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const date = new Date().toISOString().split('T')[0];
            
            link.href = url;
            link.download = `membres-eglise-${date}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert(`‚úÖ ${tousMembres.length} membre(s) export√©(s) en Excel`);
        }

        // Fonction pour exporter en PDF
        function exporterPDF() {
            if (tousMembres.length === 0) {
                alert('Aucun membre √† exporter');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');

            // En-t√™te
            doc.setFillColor(99, 102, 241);
            doc.rect(0, 0, 297, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.text('√âglise de Dieu - Maison de Lumi√®re', 148.5, 15, { align: 'center' });
            doc.setFontSize(14);
            doc.text('Liste des Membres', 148.5, 25, { align: 'center' });
            doc.setFontSize(10);
            const dateStr = new Date().toLocaleDateString('fr-FR');
            doc.text(`Date: ${dateStr}`, 148.5, 33, { align: 'center' });

            // Tableau
            const tableData = tousMembres.map(m => [
                m.nom || '',
                m.prenom || '',
                m.phone || '',
                m.email || '',
                m.statut_matrimonial || '',
                m.nationalite || ''
            ]);

            doc.autoTable({
                startY: 45,
                head: [['Nom', 'Pr√©nom', 'T√©l√©phone', 'Email', 'Statut', 'Nationalit√©']],
                body: tableData,
                theme: 'striped',
                headStyles: {
                    fillColor: [99, 102, 241],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                styles: {
                    fontSize: 9,
                    cellPadding: 3
                },
                didDrawPage: function(data) {
                    doc.setFontSize(8);
                    doc.setTextColor(128);
                    doc.text(
                        `Page ${data.pageNumber} | Total: ${tousMembres.length} membre(s)`,
                        148.5,
                        doc.internal.pageSize.height - 10,
                        { align: 'center' }
                    );
                }
            });

            const date = new Date().toISOString().split('T')[0];
            doc.save(`membres-eglise-${date}.pdf`);

            alert(`‚úÖ ${tousMembres.length} membre(s) export√©(s) en PDF`);
        }

        // Charger tous les membres au d√©marrage
        window.addEventListener('DOMContentLoaded', function() {
            if (verifierAuth()) {
                rechercherMembres();
            }
        });
    </script>
</body>
</html>
