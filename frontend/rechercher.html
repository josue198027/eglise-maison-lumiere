<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rechercher des membres - Ã‰glise de Dieu Maison de LumiÃ¨re</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-left">
        <img src="images/logo.png" alt="Logo" class="nav-logo" onerror="this.style.display='none'">
        <span class="nav-title">Ã‰glise de Dieu - Maison de LumiÃ¨re</span>
      </div>
      <div class="nav-right">
        <span class="user-name" id="userName"></span>
        <button onclick="window.location.href='/dashboard.html'" class="btn btn-secondary">Retour</button>
        <button onclick="deconnexion()" class="btn btn-secondary">DÃ©connexion</button>
      </div>
    </div>
  </nav>

  <!-- Contenu principal -->
  <div class="container">
    <h1 class="page-title">Rechercher et consulter les membres</h1>

    <!-- Barre de recherche -->
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="Rechercher par nom, prÃ©nom, email ou tÃ©lÃ©phone..." class="search-input">
      <button onclick="rechercher()" class="btn btn-primary">Rechercher</button>
      <button onclick="voirTous()" class="btn btn-secondary">Voir tous</button>
    </div>

    <!-- Message -->
    <div id="message" class="message" style="display: none;"></div>

    <!-- RÃ©sultats -->
    <div id="resultats" class="membres-grid"></div>
  </div>

  <script src="js/app.js"></script>
  <script>
    // VÃ©rifier l'authentification
    verifierAuth();
    afficherNomUtilisateur();

    // Charger tous les membres au dÃ©marrage
    voirTous();

    // Recherche en temps rÃ©el
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const query = e.target.value.trim();
      if (query.length > 0) {
        rechercher();
      } else {
        voirTous();
      }
    });

    // Rechercher avec la touche EntrÃ©e
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        rechercher();
      }
    });

    async function rechercher() {
      const query = document.getElementById('searchInput').value.trim();
      
      if (!query) {
        voirTous();
        return;
      }

      try {
        const membres = await fetchAPI(`/api/membres/rechercher/query?q=${encodeURIComponent(query)}`);
        afficherMembres(membres);
      } catch (error) {
        afficherMessage('Erreur lors de la recherche', 'error');
      }
    }

    async function voirTous() {
      try {
        const membres = await fetchAPI('/api/membres');
        afficherMembres(membres);
      } catch (error) {
        afficherMessage('Erreur lors du chargement des membres', 'error');
      }
    }

    function afficherMembres(membres) {
      const resultatsDiv = document.getElementById('resultats');

      if (membres.length === 0) {
        resultatsDiv.innerHTML = '<p class="no-results">Aucun membre trouvÃ©</p>';
        return;
      }

      resultatsDiv.innerHTML = membres.map(membre => `
        <div class="membre-card">
          <div class="membre-header">
            <h3>${membre.nom} ${membre.prenom}</h3>
          </div>
          <div class="membre-info">
            ${membre.phone ? `<p><strong>ğŸ“ TÃ©lÃ©phone:</strong> ${membre.phone}</p>` : ''}
            ${membre.email ? `<p><strong>ğŸ“§ Email:</strong> ${membre.email}</p>` : ''}
            ${membre.adresse ? `<p><strong>ğŸ“ Adresse:</strong> ${membre.adresse}</p>` : ''}
            ${membre.statut_matrimonial ? `<p><strong>ğŸ’‘ Statut:</strong> ${membre.statut_matrimonial}</p>` : ''}
            ${membre.nombre_enfants !== null ? `<p><strong>ğŸ‘¶ Enfants:</strong> ${membre.nombre_enfants}</p>` : ''}
            ${membre.nationalite ? `<p><strong>ğŸŒ NationalitÃ©:</strong> ${membre.nationalite}</p>` : ''}
            ${membre.langue_parlee ? `<p><strong>ğŸ—£ï¸ Langue:</strong> ${membre.langue_parlee}</p>` : ''}
            ${membre.niveau_etude ? `<p><strong>ğŸ“ Niveau d'Ã©tude:</strong> ${membre.niveau_etude}</p>` : ''}
          </div>
          <div class="membre-actions">
            <button onclick="modifierMembre(${membre.id})" class="btn btn-primary btn-sm">Modifier</button>
            <button onclick="supprimerMembre(${membre.id}, '${membre.nom} ${membre.prenom}')" class="btn btn-danger btn-sm">Supprimer</button>
          </div>
        </div>
      `).join('');
    }

    function modifierMembre(id) {
      window.location.href = `/modifier.html?id=${id}`;
    }

    async function supprimerMembre(id, nom) {
      if (!confirm(`ÃŠtes-vous sÃ»r de vouloir supprimer ${nom} ?`)) {
        return;
      }

      try {
        await fetchAPI(`/api/membres/${id}`, {
          method: 'DELETE'
        });

        afficherMessage('Membre supprimÃ© avec succÃ¨s', 'success');
        voirTous();
      } catch (error) {
        afficherMessage('Erreur lors de la suppression', 'error');
      }
    }

    function afficherMessage(texte, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = texte;
      messageDiv.style.display = 'block';

      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 3000);
    }
  </script>
</body>
</html>
